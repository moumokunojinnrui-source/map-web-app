<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MapMemo</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk1hcE1lbW8iLAogICJzaG9ydF9uYW1lIjogIk1hcE1lbW8iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM4QjAwMDAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCQ1J3MEtHZ29BQUFBTlNVaEVVZ0FBQU1BQUFBS0NBWUFBQUJTM2dodmFBQU1XRWxFUVZSNFh1M2RlMVFVOXg3SDhkMEEiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
<style>
  /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
  body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; }
  #map { height: 100vh; width: 100%; }

  /* --- èª¬æ˜ãƒšãƒ¼ã‚¸ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
  .info-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(250, 250, 250, 0.98);
    z-index: 2000;
    overflow-y: auto;
    display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
    color: #333;
  }
  .info-overlay main {
    max-width: 800px; margin: 60px auto;
    padding: 0 20px; line-height: 1.8;
  }
  .info-overlay h1 { font-size: 1.8em; border-bottom: 2px solid #ddd; padding-bottom: 0.4em; }
  .info-overlay h2 { margin-top: 2em; font-size: 1.4em; border-left: 5px solid #5b8def; padding-left: 0.6em; }
  .info-overlay ul { padding-left: 20px; }

  /* --- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒœã‚¿ãƒ³ & ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
  .hamburger {
    position: fixed; bottom: 20px; right: 20px;
    width: 50px; height: 50px; background: #333;
    border-radius: 50%; display: flex; flex-direction: column;
    justify-content: center; align-items: center; cursor: pointer;
    z-index: 2001;
  }
  .hamburger span { width: 26px; height: 3px; background: #fff; margin: 3px 0; transition: 0.3s; }
  .menu {
    position: fixed; bottom: 80px; right: 20px;
    background: white; border: 1px solid #ddd; border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: none; flex-direction: column; overflow: hidden;
    z-index: 2001;
  }
  .menu a { padding: 12px 20px; text-decoration: none; color: #333; border-bottom: 1px solid #eee; }
  .menu a:hover { background: #f5f5f5; }
  .menu a:last-child { border-bottom: none; }
  
  /* --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
  .custom-popup .leaflet-popup-content-wrapper { background: #fff; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
  .custom-popup .leaflet-popup-content { margin: 0; color: #333; padding: 15px; width: auto !important; min-width: 250px; }
  .custom-popup h3 { margin: 0 0 10px; font-size: 18px; }
  .custom-popup p { margin: 5px 0; font-size: 14px; }
  .input-field, .custom-popup select { width: 100%; height: 48px; padding: 0 12px; font-size: 16px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 10px; }
  .action-buttons button { background: #8B0000; color: white; border: none; width: calc(50% - 5px); height: 48px; cursor: pointer; font-size: 16px; }
  .action-buttons .cancel-btn { background: #666; float: right; }
  .share-btn { background: #8B0000; color: white; border: none; width: 100%; height: 48px; cursor: pointer; font-size: 16px; margin-top: 10px; }
  .share-container { margin-top: 10px; display: none; }
  .share-container textarea { width: 100%; height: 100px; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
  .share-container button { margin-top: 5px; padding: 5px 10px; background: #8B0000; color: white; border: none; cursor: pointer; }
  .diamond {
    width: 30px; height: 50px; background: linear-gradient(45deg, #1e90ff, #add8e6);
    position: relative; cursor: pointer; transition: transform 0.3s ease;
    clip-path: polygon(50% 0%, 85% 25%, 85% 75%, 50% 100%, 15% 75%, 15% 25%);
    border: 1px solid rgba(255, 255, 255, 0.5); display: flex;
    align-items: center; justify-content: center;
  }
  .sparkle { animation: sparkle 1.5s infinite; }
  @keyframes sparkle {
    0%, 100% { box-shadow: 0 0 12px 6px rgba(30, 144, 255, 0.7); }
    50% { box-shadow: 0 0 18px 9px rgba(255, 255, 255, 0.9); }
  }
  .diamond:hover { transform: scale(1.2); }
</style>
</head>
<body>
  <div id="map"></div>

  <div class="info-overlay" id="info-overlay">
    <main id="content"></main>
  </div>

  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <div class="menu" id="menu">
    <a href="#" onclick="showPage('description')">ğŸ—º èª¬æ˜æ–‡</a>
    <a href="#" onclick="showPage('policy')">ğŸš« ã”åˆ©ç”¨ã®ãŠé¡˜ã„</a>
    <a href="#" onclick="showPage('map')">â†©ï¸ åœ°å›³ã«æˆ»ã‚‹</a>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  /* --- ã“ã“ã‹ã‚‰åœ°å›³ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ --- */

  const SUPABASE_URL = 'https://prubpguljspcfjrvpqpc.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_6SMcLyOZtpUkp2Ajmc56hg_Hce0XOJn';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const map = L.map('map').setView([35.68, 139.76], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      attribution: 'Â© OpenStreetMap',
      maxZoom: 22
  }).addTo(map);
  const markers = L.markerClusterGroup();
  const prefectures = ['åŒ—æµ·é“', 'é’æ£®çœŒ', 'å²©æ‰‹çœŒ', 'å®®åŸçœŒ', 'ç§‹ç”°çœŒ', 'å±±å½¢çœŒ', 'ç¦å³¶çœŒ', 'èŒ¨åŸçœŒ', 'æ ƒæœ¨çœŒ', 'ç¾¤é¦¬çœŒ', 'åŸ¼ç‰çœŒ', 'åƒè‘‰çœŒ', 'æ±äº¬éƒ½', 'ç¥å¥ˆå·çœŒ', 'æ–°æ½ŸçœŒ', 'å¯Œå±±çœŒ', 'çŸ³å·çœŒ', 'ç¦äº•çœŒ', 'å±±æ¢¨çœŒ', 'é•·é‡çœŒ', 'å²é˜œçœŒ', 'é™å²¡çœŒ', 'æ„›çŸ¥çœŒ', 'ä¸‰é‡çœŒ', 'æ»‹è³€çœŒ', 'äº¬éƒ½åºœ', 'å¤§é˜ªåºœ', 'å…µåº«çœŒ', 'å¥ˆè‰¯çœŒ', 'å’Œæ­Œå±±çœŒ', 'é³¥å–çœŒ', 'å³¶æ ¹çœŒ', 'å²¡å±±çœŒ', 'åºƒå³¶çœŒ', 'å±±å£çœŒ', 'å¾³å³¶çœŒ', 'é¦™å·çœŒ', 'æ„›åª›çœŒ', 'é«˜çŸ¥çœŒ', 'ç¦å²¡çœŒ', 'ä½è³€çœŒ', 'é•·å´çœŒ', 'ç†Šæœ¬çœŒ', 'å¤§åˆ†çœŒ', 'å®®å´çœŒ', 'é¹¿å…å³¶çœŒ', 'æ²–ç¸„çœŒ'];

  async function loadPins() {
    markers.clearLayers();
    const { data, error } = await supabaseClient
      .from('mapmemo')
      .select('id, name, area, lat, lng, year');
    if (error) {
      console.error('ãƒ”ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message, error.details);
      alert('ãƒ”ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      return;
    }
    if (!data || data.length === 0) return;

    const pinGroups = data.reduce((acc, pin) => {
      const key = `${pin.lat},${pin.lng}`;
      if (!acc[key]) acc[key] = [];
      acc[key].push(pin);
      return acc;
    }, {});

    Object.values(pinGroups).forEach(pins => {
      const [lat, lng] = [pins[0].lat, pins[0].lng];
      const diamondIcon = L.divIcon({
        html: `<div class="diamond"></div>`,
        className: 'sparkle',
        iconSize: [30, 50], iconAnchor: [15, 50], popupAnchor: [0, -50]
      });
      const marker = L.marker([lat, lng], { icon: diamondIcon });
      marker.bindPopup(() => createViewPopup(pins), { className: 'custom-popup' });
      markers.addLayer(marker);
    });
    map.addLayer(markers);
  }

  function createViewPopup(pins) {
    const container = document.createElement('div');
    let currentPin = pins[0];

    const updateContent = () => {
      container.innerHTML = `
        <h3>${currentPin.name}</h3>
        <p><strong>ã‚¨ãƒªã‚¢:</strong> ${currentPin.area}</p>
        <select id="yearSelect">
          ${pins.map(p => `<option value="${p.id}" ${p.id === currentPin.id ? 'selected' : ''}>${p.year}å¹´</option>`).join('')}
        </select>
        <button class="share-btn">å…±æœ‰</button>
        <div class="share-container"></div>
      `;
    };

    container.addEventListener('change', e => {
      if (e.target.id === 'yearSelect') {
        const selectedId = e.target.value;
        currentPin = pins.find(p => p.id === selectedId) || pins[0];
        updateContent();
      }
    });

    container.addEventListener('click', e => {
      if (e.target.classList.contains('share-btn')) {
        const shareContainer = container.querySelector('.share-container');
        if (shareContainer.style.display === 'none' || !shareContainer.style.display) {
          const shareText = `ãŠåº—ã®åå‰: ${currentPin.name}\nè¥¿æš¦: ${currentPin.year}\nç·¯åº¦: ${currentPin.lat}\nçµŒåº¦: ${currentPin.lng}`;
          shareContainer.innerHTML = `
            <p style="font-size:12px; margin-bottom:5px;">ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦SNSã§å…±æœ‰ã§ãã¾ã™ã€‚</p>
            <textarea readonly>${shareText}</textarea>
            <button class="copy-btn">ã‚³ãƒ”ãƒ¼</button>
          `;
          shareContainer.style.display = 'block';
          shareContainer.querySelector('.copy-btn').addEventListener('click', () => {
            const textarea = shareContainer.querySelector('textarea');
            textarea.select();
            document.execCommand('copy');
            alert('æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼SNSã§å…±æœ‰ã—ã¦ãã ã•ã„');
          });
        } else {
          shareContainer.style.display = 'none';
        }
      }
    });
    updateContent();
    return container;
  }

  map.on('contextmenu', (e) => {
    const { lat, lng } = e.latlng;
    const popupContent = `
      <h3>æ–°ã—ã„ãƒ”ãƒ³ã‚’ç™»éŒ²</h3>
      <input type="text" id="newName" class="input-field" placeholder="åº—åï¼ˆå¿…é ˆ, 50æ–‡å­—ä»¥å†…ï¼‰" maxlength="50">
      <select id="newArea" class="input-field">
        <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
        ${prefectures.map(pref => `<option value="${pref}">${pref}</option>`).join('')}
      </select>
      <input type="number" id="newYear" class="input-field" placeholder="è¥¿æš¦ï¼ˆå¿…é ˆ, 1900-2025ï¼‰" min="1900" max="2025">
      <div class="action-buttons">
        <button class="save-btn">ä¿å­˜</button>
        <button class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `;
    const popup = L.popup({ className: 'custom-popup' }).setLatLng(e.latlng).setContent(popupContent).openOn(map);

    const container = popup.getElement().querySelector('.leaflet-popup-content');
    container.querySelector('.save-btn').addEventListener('click', async () => {
      const name = container.querySelector('#newName').value.trim();
      const area = container.querySelector('#newArea').value;
      const year = parseInt(container.querySelector('#newYear').value);
      if (!name || !area || !year || year < 1900 || year > 2025) {
        alert('åº—åã€éƒ½é“åºœçœŒã€æœ‰åŠ¹ãªè¥¿æš¦ï¼ˆ1900-2025ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      const { data: pinData, error: pinError } = await supabaseClient
        .from('mapmemo')
        .insert([{ name, area, lat, lng, year }])
        .select().single();
      if (pinError) {
        console.error('ãƒ”ãƒ³ã®ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', pinError.message, pinError.details);
        alert('ãƒ”ãƒ³ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + pinError.message);
        return;
      }
      map.closePopup();
      loadPins();
    });
    container.querySelector('.cancel-btn').addEventListener('click', () => map.closePopup());
  });

  function checkUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const lat = params.get('lat');
    const lng = params.get('lng');
    const zoom = params.get('zoom');
    if (lat && lng) {
      map.setView([parseFloat(lat), parseFloat(lng)], zoom ? parseInt(zoom) : 15);
    }
  }

  if ('serviceWorker' in navigator && location.protocol !== 'file:') {
    const swCode = `self.addEventListener('install',e=>{e.waitUntil(caches.open('mapmemo-v1').then(c=>c.addAll(['/','https://unpkg.com/leaflet@1.9.4/dist/leaflet.js','https://unpkg.com/leaflet@1.9.4/dist/leaflet.css','https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js','https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css','https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css','https://unpkg.com/@supabase/supabase-js@2'])))})
self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(err => console.error('Service Workerç™»éŒ²ã‚¨ãƒ©ãƒ¼:', err.message));
  }

  loadPins();
  checkUrlParams();

  /* --- ã“ã“ã‹ã‚‰èª¬æ˜ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ --- */

  const hamburger = document.getElementById("hamburger");
  const menu = document.getElementById("menu");
  const infoOverlay = document.getElementById("info-overlay");
  const content = document.getElementById("content");

  hamburger.addEventListener("click", () => {
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  });

  const pages = {
    description: `
      <h1>ğŸ—º MapMemoã¨ã¯</h1>
      <p>ç§ãŸã¡ãŒæš®ã‚‰ã—ã¦ããŸç”ºã«ã¯ã€ã‚‚ã†å§¿ã‚’æ¶ˆã—ã¦ã—ã¾ã£ãŸå–«èŒ¶åº—ã€å•†åº—è¡—ã®å°ã•ãªåº—ã€æ˜ ç”»é¤¨ã‚„ã‚²ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ãªã©ã€å¿˜ã‚Œã‚‰ã‚Œãã†ã§å¿˜ã‚Œã‚‰ã‚Œãªã„å ´æ‰€ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã—ãŸã€‚</p>
      <p>ã‘ã‚Œã©ã€ãã®å¤šãã¯èª°ã«ã‚‚è¨˜éŒ²ã•ã‚Œãªã„ã¾ã¾ã€é™ã‹ã«æ¶ˆãˆã¦ã„ãã¾ã™ã€‚</p>
      <p><strong>MapMemo</strong> ã¯ã€ãã†ã—ãŸ â€œã‚‚ã†ç„¡ã„ã‘ã‚Œã©å¿ƒã«æ®‹ã£ã¦ã„ã‚‹ãŠåº—â€ ã‚’æ®‹ã—ã¦ã„ããŸã‚ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åœ°å›³ã§ã™ã€‚åœ°å›³ã‚’é–‹ã‘ã°ã€ã‹ã¤ã¦ãã“ã«ã‚ã£ãŸãŠåº—ã‚’è¦‹ã¤ã‘ã¦æ‡ã‹ã—ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€ã‚‚ã—ã‚ãªãŸãŒè¦šãˆã¦ã„ã‚‹ãŠåº—ãŒã‚ã‚Œã°ã€åº—åã ã‘ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ç°¡å˜ã«æŠ•ç¨¿ã—ã¦è¨˜éŒ²ã‚’æ®‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      <p>èª°ã‹ãŒæ€ã„å‡ºã®ä¸€éƒ¨ã‚’æ®‹ã—ã€èª°ã‹ãŒãã‚Œã‚’è¦‹ã¤ã‘ã¦æ‡ã‹ã—ã‚€ã€‚ãã‚“ãªå°ã•ãªå¾ªç’°ã‚’å°‘ã—ãšã¤ç©ã¿é‡ã­ã€ç”ºã®è¨˜æ†¶ã‚’æœªæ¥ã¸ã¤ãªã’ã¦ã„ããŸã„â€•â€•ãã‚ŒãŒ MapMemo ã®é¡˜ã„ã§ã™ã€‚</p>
      <p>ã©ã†ã‹ã€ã‚ãªãŸã®è¨˜æ†¶ã‚‚ 1 ä»¶ã ã‘ã§ã‚‚å‚åŠ ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®æŠ•ç¨¿ãŒã€èª°ã‹ã®æ‡ã‹ã—ã•ã‚’å‘¼ã³èµ·ã“ã™ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</p>
    `,
    policy: `
      <h1>ğŸš« ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦ã®ãŠé¡˜ã„</h1>
      <p>MapMemo ã¯ã€Œç”ºã®è¨˜æ†¶ã‚’æœªæ¥ã«æ®‹ã™ã€ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸå¸‚æ°‘ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚ãã®ãŸã‚ã€ä»¥ä¸‹ã®è¡Œç‚ºã¯ã”é æ…®ãã ã•ã„ã€‚</p>
      <ul>
        <li>äº‹å®Ÿã¨ç•°ãªã‚‹æƒ…å ±ã€è™šå½ã®æŠ•ç¨¿</li>
        <li>å€‹äººã‚„åº—èˆ—ã‚’èª¹è¬—ãƒ»ä¸­å‚·ã™ã‚‹å†…å®¹ã®æŠ•ç¨¿</li>
        <li>æ‚ªæ„ã‚ã‚‹ã‚¤ã‚¿ã‚ºãƒ©æŠ•ç¨¿ã‚„ã€ä»–äººã®è¿·æƒ‘ã¨ãªã‚‹åˆ©ç”¨</li>
      </ul>
      <p>æŠ•ç¨¿å†…å®¹ã¯ã€ã™ã¹ã¦ã®äººãŒå®‰å¿ƒã—ã¦é–²è¦§ã§ãã‚‹ã‚ˆã†ã€<strong>å…¬å…±æ€§ãƒ»è¨˜éŒ²æ€§ãƒ»æ•¬æ„</strong>ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®æ€ã„å‡ºãŒã€ç”ºã®å¤§åˆ‡ãªä¸€éƒ¨ã¨ã—ã¦æœªæ¥ã¸æ®‹ã‚Šã¾ã™ã€‚</p>
    `
  };

  function showPage(page) {
    if (page === 'map') {
      infoOverlay.style.display = "none";
    } else {
      content.innerHTML = pages[page];
      infoOverlay.style.display = "block";
    }
    menu.style.display = "none";
  }

</script>
</body>
</html>