<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Pano-Map Ultimate Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --accent: #28a745; --bg: #1a1a1a; }
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #000; color: white; overflow: hidden; }
        #map-area { flex: 1; border-right: 2px solid #333; }
        #pano-area { flex: 1; position: relative; background: #050505; }
        #ui-panel {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: rgba(26, 26, 26, 0.9); padding: 20px; border-radius: 12px; width: 300px;
            backdrop-filter: blur(10px); border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .info-box { background: #000; padding: 10px; border-radius: 6px; margin: 10px 0; font-family: monospace; font-size: 12px; color: #00d4ff; border: 1px solid #333; }
        h2 { font-size: 16px; margin: 0 0 15px 0; color: var(--accent); border-bottom: 1px solid #444; padding-bottom: 8px; }
        label { display: block; font-size: 11px; color: #aaa; margin-bottom: 5px; text-transform: uppercase; }
        input { width: 100%; padding: 8px; box-sizing: border-box; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 15px; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover:not(:disabled) { background: #218838; transform: translateY(-1px); }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.5; }
        #status-msg { font-size: 11px; margin-top: 10px; color: #ffc107; }
    </style>
</head>
<body>

<div id="map-area"></div>
<div id="pano-area">
    <div id="ui-panel">
        <h2>Pano-Map Creator</h2>
        
        <label>1. パノラマ画像を選択</label>
        <input type="file" id="inp-img" accept="image/*">

        <label>2. 地図で場所を指定</label>
        <div id="disp-pos" class="info-box">地図をクリックしてください</div>

        <label>3. タイトル</label>
        <input type="text" id="inp-title" placeholder="例：〇〇ビル 屋上展望台">

        <button id="btn-export" disabled>最終HTMLを保存</button>
        <div id="status-msg"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="importmap">
{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // 一元管理されるステート
    const APP_STATE = {
        lat: null, lng: null, zoom: 15,
        azim: 0, polar: Math.PI/2, fov: 75,
        base64: null, fileName: ""
    };

    // --- 地図セクション ---
    const map = L.map('map-area').setView([35.6812, 139.7671], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker;
    map.on('click', (e) => {
        const { lat, lng } = e.latlng;
        if (marker) marker.setLatLng(e.latlng);
        else marker = L.marker(e.latlng).addTo(map);
        APP_STATE.lat = lat; APP_STATE.lng = lng; APP_STATE.zoom = map.getZoom();
        document.getElementById('disp-pos').textContent = `LAT: ${lat.toFixed(5)}\nLNG: ${lng.toFixed(5)}`;
        checkReady();
    });

    // --- パノラマセクション ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
    camera.position.set(0, 0, 0.1);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    const panoEl = document.getElementById('pano-area');
    renderer.setSize(panoEl.clientWidth, panoEl.clientHeight);
    panoEl.appendChild(renderer.domElement);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    document.getElementById('inp-img').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        APP_STATE.fileName = file.name;
        const reader = new FileReader();
        reader.onload = (ev) => {
            APP_STATE.base64 = ev.target.result;
            new THREE.TextureLoader().load(APP_STATE.base64, (t) => {
                t.mapping = THREE.EquirectangularReflectionMapping;
                t.colorSpace = THREE.SRGBColorSpace;
                scene.background = t;
                document.getElementById('status-msg').textContent = "画像読み込み完了。角度を調整してください。";
                checkReady();
            });
        };
        reader.readAsDataURL(file);
    });

    function checkReady() {
        document.getElementById('btn-export').disabled = !(APP_STATE.lat && APP_STATE.base64);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
        APP_STATE.azim = controls.getAzimuthalAngle();
        APP_STATE.polar = controls.getPolarAngle();
        APP_STATE.fov = camera.fov;
    }
    animate();

    // --- 書き出しセクション ---
    document.getElementById('btn-export').addEventListener('click', () => {
        const title = document.getElementById('inp-title').value || "Panorama Tour";
        
        // 最終成果物となるHTMLコードの生成
        const finalHtml = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; }
        #close { position: absolute; top: 20px; right: 20px; padding: 12px 24px; background: #fff; border: none; cursor: pointer; z-index: 10001; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #v { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="overlay">
        <button id="close" onclick="closePano()">地図に戻る</button>
        <div id="v"></div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
    <script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
    <\/script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // データの埋め込み
        const D = {
            lat: ${APP_STATE.lat}, lng: ${APP_STATE.lng}, zoom: ${APP_STATE.zoom},
            azim: ${APP_STATE.azim}, polar: ${APP_STATE.polar}, fov: ${APP_STATE.fov},
            title: ${JSON.stringify(title)},
            img: ${JSON.stringify(APP_STATE.base64)}
        };

        // 地図初期化
        const m = L.map('map').setView([D.lat, D.lng], D.zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
        L.marker([D.lat, D.lng]).addTo(m).bindPopup("<b>"+D.title+"</b><br><br><button onclick='window.openPano()'>パノラマを見る</button>").openPopup();

        // パノラマ初期化
        let scene, camera, renderer, controls;
        function initPano() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(D.fov, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('v').appendChild(renderer.domElement);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            const dist = 0.1;
            camera.position.set(dist*Math.sin(D.azim)*Math.sin(D.polar), dist*Math.cos(D.polar), dist*Math.cos(D.azim)*Math.sin(D.polar));
            
            new THREE.TextureLoader().load(D.img, (t) => {
                t.mapping = THREE.EquirectangularReflectionMapping;
                t.colorSpace = THREE.SRGBColorSpace;
                scene.background = t;
            });
            function anim() { requestAnimationFrame(anim); controls.update(); renderer.render(scene, camera); }
            anim();
        }

        window.openPano = () => {
            document.getElementById('overlay').style.display = 'block';
            if(!scene) initPano();
        };
        window.closePano = () => { document.getElementById('overlay').style.display = 'none'; };
        window.addEventListener('resize', () => { 
            if(camera) {
                camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    <\/script>
</body>
</html>`;

        const blob = new Blob([finalHtml], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "PanoMap_Final.html";
        a.click();
    });
</script>
</body>
</html>