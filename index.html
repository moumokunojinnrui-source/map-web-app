<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapMemo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk1hcE1lbW8iLAogICJzaG9ydF9uYW1lIjogIk1hcE1lbW8iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM4QjAwMDAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCQ1J3MEtHZ29BQUFBTlNVaEVVZ0FBQU1BQUFBS0NBWUFBQUJTM2dodmFBQU1XRWxFUVZSNFh1M2RlMVFVOXg3SDhkMEEiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
  <style>
    body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; font-family: 'Arial', sans-serif; }
    #map { height: 100vh; width: 100%; }
    .custom-popup .leaflet-popup-content-wrapper { background: #fff; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    .custom-popup .leaflet-popup-content { margin: 0; color: #333; padding: 15px; width: auto !important; min-width: 250px; }
    .custom-popup h3 { margin: 0 0 10px; font-size: 18px; }
    .custom-popup p { margin: 5px 0; font-size: 14px; }
    .input-field, .custom-popup select { width: 100%; height: 48px; padding: 0 12px; font-size: 16px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 10px; }
    .action-buttons button { background: #8B0000; color: white; border: none; width: calc(50% - 5px); height: 48px; cursor: pointer; font-size: 16px; }
    .action-buttons .cancel-btn { background: #666; float: right; }
    .share-btn { background: #8B0000; color: white; border: none; width: 100%; height: 48px; cursor: pointer; font-size: 16px; margin-top: 10px; }
    .share-container { margin-top: 10px; display: none; }
    .share-container input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    .share-container button { margin-top: 5px; padding: 5px 10px; background: #8B0000; color: white; border: none; cursor: pointer; }
    .diamond {
      width: 30px; height: 50px; background: linear-gradient(45deg, #1e90ff, #add8e6);
      position: relative; cursor: pointer; transition: transform 0.3s ease;
      clip-path: polygon(50% 0%, 85% 25%, 85% 75%, 50% 100%, 15% 75%, 15% 25%);
      border: 1px solid rgba(255, 255, 255, 0.5); display: flex;
      align-items: center; justify-content: center;
    }
    .sparkle { animation: sparkle 1.5s infinite; }
    @keyframes sparkle {
      0%, 100% { box-shadow: 0 0 12px 6px rgba(30, 144, 255, 0.7); }
      50% { box-shadow: 0 0 18px 9px rgba(255, 255, 255, 0.9); }
    }
    .diamond:hover { transform: scale(1.2); }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Supabase初期化
    const SUPABASE_URL = 'https://prubpguljspcfjrvpqpc.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_6SMcLyOZtpUkp2Ajmc56hg_Hce0XOJn';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Leafletマップ初期化
    const map = L.map('map').setView([35.68, 139.76], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
    const markers = L.markerClusterGroup();

    // エリアリスト
    const prefectures = ['北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県', '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県', '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県', '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県', '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県', '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県', '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'];

    // ピンの読み込み
    async function loadPins() {
      markers.clearLayers();
      const { data, error } = await supabaseClient
        .from('mapmemo')
        .select('id, name, area, lat, lng, year');
      if (error) {
        console.error('ピン取得エラー:', error.message, error.details);
        alert('ピンの取得に失敗しました: ' + error.message);
        return;
      }
      if (!data || data.length === 0) return;

      const pinGroups = data.reduce((acc, pin) => {
        const key = `${pin.lat},${pin.lng}`;
        if (!acc[key]) acc[key] = [];
        acc[key].push(pin);
        return acc;
      }, {});

      Object.values(pinGroups).forEach(pins => {
        const [lat, lng] = [pins[0].lat, pins[0].lng];
        const diamondIcon = L.divIcon({
          html: `<div class="diamond"></div>`,
          className: 'sparkle',
          iconSize: [30, 50],
          iconAnchor: [15, 50],
          popupAnchor: [0, -50]
        });
        const marker = L.marker([lat, lng], { icon: diamondIcon });
        marker.bindPopup(() => createViewPopup(pins), { className: 'custom-popup' });
        markers.addLayer(marker);
      });
      map.addLayer(markers);
    }

    // ピンのポップアップ作成
    function createViewPopup(pins) {
      const container = document.createElement('div');
      let currentPin = pins[0];

      const updateContent = () => {
        container.innerHTML = `
          <h3>${currentPin.name}</h3>
          <p><strong>エリア:</strong> ${currentPin.area}</p>
          <select id="yearSelect">
            ${pins.map(p => `<option value="${p.id}" ${p.id === currentPin.id ? 'selected' : ''}>${p.year}年</option>`).join('')}
          </select>
          <button class="share-btn">共有</button>
          <div class="share-container"></div>
        `;
      };

      container.addEventListener('change', e => {
        if (e.target.id === 'yearSelect') {
          const selectedId = e.target.value;
          currentPin = pins.find(p => p.id === selectedId) || pins[0];
          updateContent();
        }
      });

      container.addEventListener('click', e => {
        if (e.target.classList.contains('share-btn')) {
          const shareContainer = container.querySelector('.share-container');
          if (shareContainer.style.display === 'none' || !shareContainer.style.display) {
            const shareText = `${currentPin.name} (${currentPin.area}, ${currentPin.year || '不明'})`;
            const shareUrl = `https://mapmemo.vercel.app/?lat=${currentPin.lat}&lng=${currentPin.lng}&zoom=15`;
            shareContainer.innerHTML = `
              <p style="font-size:12px; margin-bottom:5px;">以下のリンクをコピーしてSNSで共有できます。</p>
              <input type="text" readonly value="${shareText}\n${shareUrl}">
              <button class="copy-btn">コピー</button>
            `;
            shareContainer.style.display = 'block';
            shareContainer.querySelector('.copy-btn').addEventListener('click', () => {
              const input = shareContainer.querySelector('input');
              input.select();
              document.execCommand('copy');
              alert('リンクをコピーしました！SNSで共有してください');
            });
          } else {
            shareContainer.style.display = 'none';
          }
        }
      });

      updateContent();
      return container;
    }

    // ピンの登録
    map.on('contextmenu', (e) => {
      const { lat, lng } = e.latlng;
      const popupContent = `
        <h3>新しいピンを登録</h3>
        <input type="text" id="newName" class="input-field" placeholder="店名（必須, 50文字以内）" maxlength="50">
        <select id="newArea" class="input-field">
          <option value="">都道府県を選択</option>
          ${prefectures.map(pref => `<option value="${pref}">${pref}</option>`).join('')}
        </select>
        <input type="number" id="newYear" class="input-field" placeholder="西暦（必須, 1900-2025）" min="1900" max="2025">
        <div class="action-buttons">
          <button class="save-btn">保存</button>
          <button class="cancel-btn">キャンセル</button>
        </div>
      `;
      const popup = L.popup({ className: 'custom-popup' }).setLatLng(e.latlng).setContent(popupContent).openOn(map);

      const container = popup.getElement().querySelector('.leaflet-popup-content');
      container.querySelector('.save-btn').addEventListener('click', async () => {
        const name = container.querySelector('#newName').value.trim();
        const area = container.querySelector('#newArea').value;
        const year = parseInt(container.querySelector('#newYear').value);

        if (!name || !area || !year || year < 1900 || year > 2025) {
          alert('店名、都道府県、有効な西暦（1900-2025）を入力してください');
          return;
        }

        const { data: pinData, error: pinError } = await supabaseClient
          .from('mapmemo')
          .insert([{ name, area, lat, lng, year }])
          .select()
          .single();
        if (pinError) {
          console.error('ピンの登録エラー:', pinError.message, pinError.details);
          alert('ピンの登録に失敗しました: ' + pinError.message);
          return;
        }

        map.closePopup();
        loadPins();
      });
      container.querySelector('.cancel-btn').addEventListener('click', () => map.closePopup());
    });

    // URLパラメータのチェック
    function checkUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const lat = params.get('lat');
      const lng = params.get('lng');
      const zoom = params.get('zoom');
      if (lat && lng) {
        map.setView([parseFloat(lat), parseFloat(lng)], zoom ? parseInt(zoom) : 15);
      }
    }

    // サービスワーカー登録
    if ('serviceWorker' in navigator && location.protocol !== 'file:') {
      const swCode = `
        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open('mapmemo-v1').then(cache => {
              return cache.addAll([
                '/',
                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
                'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js',
                'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css',
                'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css',
                'https://unpkg.com/@supabase/supabase-js@2'
              ]);
            })
          );
        });
        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request).then(response => {
              return response || fetch(event.request);
            })
          );
        });
      `;
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(err => {
        console.error('Service Worker登録エラー:', err.message);
      });
    }

    // 初期化
    loadPins();
    checkUrlParams();
  </script>
</body>
</html>